<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë™ë„¤ ì†Œë¶„ ë§ˆì¼“</title>
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { width: 100%; height: 100vh; } /* ì§€ë„ ì „ì²´ í™”ë©´ */
        .floating-btn {
            position: fixed; bottom: 20px; right: 20px; z-index: 100;
            background: #4CAF50; color: white; padding: 15px 20px;
            border-radius: 50px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-weight: bold; text-decoration: none;
        }
        .info-box { padding: 10px; min-width: 150px; }
        .auth-box {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            background: white; padding: 10px; border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div style="position: fixed; bottom: 10px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 8px; z-index: 9999; color: white;">
    <div style="font-size: 12px; margin-bottom: 5px; font-weight: bold;">âš¡ Dev Tools</div>
    <button onclick="quickLogin('host1', 'password123')" style="background: #ff9800; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">ğŸ‘¨â€ğŸ’¼ ë°©ì¥(host1)</button>
    <button onclick="quickLogin('parti1', 'password123')" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">ğŸ™‹ ì°¸ì—¬ì(parti1)</button>
    <button onclick="quickLogin('parti2', 'password123')" style="background: #45a049; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">ğŸ™‹ ì°¸ì—¬ì(parti2)</button>
</div>

<div class="auth-box" id="authBox">
    <a href="/login">ë¡œê·¸ì¸</a> | <a href="/register">íšŒì›ê°€ì…</a>
</div>

<div id="map"></div>

<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_JS_KEY"></script>

<a href="/post/write" class="floating-btn" id="writeBtn" style="display:none;">+ ê¸€ì“°ê¸°</a>

<script>
    let myUserId = null;
    // 1. ì§€ë„ ë„ìš°ê¸° (ê¸°ë³¸: ë¶€ì‚°ëŒ€í•™êµ)
    var mapContainer = document.getElementById('map');
    var mapOption = {
        center: new kakao.maps.LatLng(35.232, 129.082), // ë¶€ì‚°ëŒ€ ë¶ë¬¸ ê·¼ì²˜
        level: 4 // í™•ëŒ€ ë ˆë²¨
    };
    var map = new kakao.maps.Map(mapContainer, mapOption);

    // 2. ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ (JWT í† í°ì´ localStorageì— ìˆëŠ”ì§€)
    const token = localStorage.getItem('accessToken');
    const authBox = document.getElementById('authBox');
    const writeBtn = document.getElementById('writeBtn');

    if (token) {
        // ë¡œê·¸ì¸ ëœ ìƒíƒœ
        authBox.innerHTML = `
                <span>í™˜ì˜í•©ë‹ˆë‹¤!</span>
                <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            `;
        writeBtn.style.display = 'block'; // ê¸€ì“°ê¸° ë²„íŠ¼ ë³´ì´ê¸°
        fetchMyInfo(token).then(() => {
            loadNearbyPosts(map, token); // ë‚´ ì •ë³´ ë¨¼ì € ë°›ê³  -> ì§€ë„ ë¡œë”©
        }); // ì£¼ë³€ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
    }

    function fetchMyInfo(token) {
        return fetch('/api/users/me', {
            headers: { 'Authorization': 'Bearer ' + token }
        })
            .then(res => {
                if (!res.ok) throw new Error("í† í° ë§Œë£Œë¨");
                return res.json();
            })
            .then(user => {
                myUserId = user.userId;

                const authBox = document.getElementById('authBox');
                authBox.innerHTML = `
                <span style="margin-right: 10px;">
                    <b>${user.nickname}</b>ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!
                </span>
                <button onclick="location.href='/mypage'" style="cursor:pointer; margin-right:5px;">ë§ˆì´í˜ì´ì§€</button>
                <button onclick="logout()" style="cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
            `;

                console.log("ë‚´ ì •ë³´ ë¡œë”© ì™„ë£Œ:", user);
            })
            .catch(err => {
                console.error(err);
                logout(); // í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì—ëŸ¬ë‚˜ë©´ ê°•ì œ ë¡œê·¸ì•„ì›ƒ
            });
    }

    function logout() {
        localStorage.removeItem('accessToken');
        window.location.reload();
    }

    // 3. ì£¼ë³€ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° (API ì—°ë™)
    function loadNearbyPosts(map, token) {
        var center = map.getCenter();
        fetch(`/api/posts?longitude=${center.getLng()}&latitude=${center.getLat()}&radius=2000`, { // ë°˜ê²½ 2kmë¡œ ëŠ˜ë¦¼
            headers: { 'Authorization': 'Bearer ' + token }
        })
            .then(res => res.json())
            .then(posts => {
                console.log("ë°›ì•„ì˜¨ ë°ì´í„° í™•ì¸:", posts);
                posts.forEach(post => createMarker(map, post, token));
            });
    }

    function getMarkerImage(status) {
        // êµ¬ê¸€ ì§€ë„ ë¬´ë£Œ ì•„ì´ì½˜ ì‚¬ìš©
        const blueIcon = 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png';   // ëª¨ì§‘ì¤‘
        const redIcon = 'http://maps.google.com/mapfiles/ms/icons/red-dot.png';    // ì§„í–‰ì¤‘ (FULL, PURCHASED)
        const greenIcon = 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'; // ì™„ë£Œë¨ (í›„ê¸°ì‘ì„±ìš©)

        if (status === 'RECRUITING') return blueIcon;
        if (status === 'FULL' || status === 'PURCHASED') return redIcon;
        if (status === 'COMPLETED') return greenIcon;
        return blueIcon; // ê¸°ë³¸
    }

    // 4. ì§€ë„ì— ë§ˆì»¤ ì°ê¸°
    function createMarker(map, post, token) {

        // 1. ë‚´ê°€ ë°©ì¥(Host)ì¸ ê²½ìš°: ê±°ë˜ ì™„ë£Œ(COMPLETED) ì‹œ ì§€ë„ì—ì„œ ì œê±°
        if (myUserId === post.hostUserId) {
            if (post.status === 'COMPLETED') return;
        }
        // 2. ë‚´ê°€ ì°¸ì—¬ì(Participant)ì¸ ê²½ìš°: ë¦¬ë·° ì‘ì„± ì™„ë£Œ ì‹œ ì§€ë„ì—ì„œ ì œê±°
        else if (post.isParticipant) {
            if (post.isReviewed) return;
        }
        // 3. ì œ3ì(Stranger)ì¸ ê²½ìš°: ëª¨ì§‘ ì¤‘(RECRUITING)ì´ ì•„ë‹ˆë©´ ì§€ë„ì—ì„œ ì œê±°
        else {
            if (post.status !== 'RECRUITING') return;
        }

        // 1. ìƒíƒœì— ë”°ë¥¸ ì´ë¯¸ì§€ ì„ íƒ
        var imageSrc = getMarkerImage(post.status);
        var imageSize = new kakao.maps.Size(32, 32); // ë§ˆì»¤ í¬ê¸°
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

        // 2. ë§ˆì»¤ ìƒì„± (ì´ë¯¸ì§€ ì ìš©)
        var marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(post.latitude, post.longitude),
            map: map,
            image: markerImage // ì´ë¯¸ì§€ ì˜µì…˜ ì¶”ê°€
        });

        // --- (ì•„ë˜ ë²„íŠ¼ ìƒì„± ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ê±°ë‚˜ ì•½ê°„ ë‹¤ë“¬ìŒ) ---
        let buttonsHtml = '';

        if (myUserId === post.hostUserId) {
            // [ë°©ì¥]
            if (post.status === 'RECRUITING' || post.status === 'FULL') {
                buttonsHtml = `<button onclick="uploadReceipt(${post.postId})" style="background:#ff9800; color:white; border:none; padding:5px;">ğŸ“¸ ì˜ìˆ˜ì¦ ì¸ì¦</button>`;
            } else if (post.status === 'PURCHASED') {
                buttonsHtml = `<button onclick="completeTransaction(${post.postId})" style="background:#f44336; color:white; border:none; padding:5px;">ğŸ¤ ê±°ë˜ ì™„ë£Œ</button>`;
            } else {
                buttonsHtml = `<span style="color:green;">(ê±°ë˜ ì¢…ë£Œë¨)</span>`;
            }
        } else {
            // [ì°¸ì—¬ì]
            if (post.status === 'RECRUITING') {
                buttonsHtml = `<button onclick="joinPost(${post.postId})" style="background:#2196F3; color:white; border:none; padding:5px;">ğŸ™‹ ì°¸ì—¬í•˜ê¸°</button>`;
            } else if (post.status === 'COMPLETED') {
                // â˜… ì—¬ê¸°ì„œ 'í›„ê¸° ì‘ì„±'ì„ ìœ ë„í•©ë‹ˆë‹¤.
                buttonsHtml = `<button onclick="writeReview(${post.postId})" style="background:#4CAF50; color:white; border:none; padding:5px;">â­ í›„ê¸°ì‘ì„±</button>`;
            } else {
                buttonsHtml = `<span style="color:gray;">(ì§„í–‰ ì¤‘...)</span>`;
            }
        }

        let urlHtml = '';
        if (post.purchaseUrl) {
            // ë§í¬ê°€ ê¸¸ ìˆ˜ ìˆìœ¼ë‹ˆ 'êµ¬ë§¤ì²˜ ë°©ë¬¸' í…ìŠ¤íŠ¸ë¡œ ì¤„ì´ê³  ìƒˆ ì°½(_blank)ìœ¼ë¡œ ë„ì›€
            urlHtml = `<div style="margin-top:5px;">
                             <a href="${post.purchaseUrl}" target="_blank" style="color:#2196F3; text-decoration:none; font-size:12px;">
                               ğŸ”— êµ¬ë§¤ ì‚¬ì´íŠ¸ ë³´ê¸°
                             </a>
                           </div>`;
        }

        // 2. ìƒì„¸ ë‚´ìš© (ë„ˆë¬´ ê¸¸ë©´ ìë¥´ê¸° - ì„ íƒì‚¬í•­)
        let descHtml = '';
        const maxLen = 20; // 20ì ë„˜ìœ¼ë©´ ìë¦„

        if (post.description.length > maxLen) {
            const shortText = post.description.substring(0, maxLen) + '...';
            const fullText = post.description;

            // ì§§ì€ ë²„ì „ (ê¸°ë³¸ í‘œì‹œ)
            descHtml += `
                    <div id="desc-short-${post.postId}" style="display:block;">
                        "${shortText}"
                        <a href="javascript:void(0);" onclick="toggleDesc(${post.postId})" style="color:#999; font-size:11px; text-decoration:underline; margin-left:3px;">ë”ë³´ê¸°</a>
                    </div>
                `;

            // ê¸´ ë²„ì „ (ìˆ¨ê¹€ ìƒíƒœ)
            descHtml += `
                    <div id="desc-full-${post.postId}" style="display:none;">
                        "${fullText}"
                        <a href="javascript:void(0);" onclick="toggleDesc(${post.postId})" style="color:#999; font-size:11px; text-decoration:underline; margin-left:3px;">ì ‘ê¸°</a>
                    </div>
                `;
        } else {
            // ì§§ìœ¼ë©´ ê·¸ëƒ¥ ë‹¤ ë³´ì—¬ì¤Œ
            descHtml = `<div>"${post.description}"</div>`;
        }

        // 3. HTML ì¡°ë¦½
        var content = `
                <div class="info-box" style="padding:15px; width:220px; font-size:13px; text-align:left; border-radius:10px;">

                    <div style="border-bottom:1px solid #eee; padding-bottom:8px; margin-bottom:8px;">
                        <strong style="font-size:16px; color:#333;">${post.itemName}</strong>
                        <span style="float:right; font-size:11px; color:#666;">${post.status}</span>
                    </div>

                    <div style="margin-bottom:5px; color:#555;">
                        ğŸ‘¤ <b>${post.hostNickname}</b> <span style="color:blue; font-size:11px;">(${post.hostTrustScore.toFixed(1)}ì )</span>
                    </div>

                    <div style="margin-bottom:5px;">
                        ğŸ‘¥ ëª¨ì§‘: <b style="color:#ff5722;">${post.currentUnits}</b> / ${post.totalUnits} ëª…
                    </div>

                    <div style="margin-bottom:5px;">
                        ğŸ’° 1ì¸ë‹¹: <b>${post.pricePerUnit.toLocaleString()}ì›</b>
                    </div>

                    <div style="color:#666; font-size:12px; margin-bottom:10px;">
                        ${descHtml}
                        ${urlHtml}
                    </div>

                    <div style="text-align:center; margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                        ${buttonsHtml}
                    </div>
                </div>
            `;

        var infowindow = new kakao.maps.InfoWindow({ content: content, removable: true });
        kakao.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
        });
    }

    function quickLogin(nickname, password) {
        fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nickname: nickname, password: password })
        })
            .then(res => {
                if (!res.ok) throw new Error("ë¡œê·¸ì¸ ì‹¤íŒ¨ (ê³„ì •ì´ ì—†ê±°ë‚˜ ë¹„ë²ˆ í‹€ë¦¼)");
                return res.json();
            })
            .then(data => {
                localStorage.setItem('accessToken', data.accessToken);
                // alert(nickname + " ë¡œê·¸ì¸ ì™„ë£Œ!"); // ê·€ì°®ìœ¼ë©´ ì´ ì¤„ ì£¼ì„ ì²˜ë¦¬
                window.location.reload(); // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ì¦‰ì‹œ ì ìš©
            })
            .catch(err => {
                console.error(err);
                alert("ê³„ì •ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”!\n(/registerë¡œ ë¨¼ì € ê°€ì… í•„ìš”)");
            });
    }

    // 5. ì°¸ì—¬í•˜ê¸° ê¸°ëŠ¥
    window.joinPost = function(postId) {
        if(!confirm("ì°¸ì—¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        fetch(`/api/posts/${postId}/participate`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('accessToken') }
        }).then(res => {
            if(res.ok) { alert("ì°¸ì—¬ ì™„ë£Œ!"); location.reload(); }
            else res.text().then(msg => alert(msg));
        });
    };

    window.uploadReceipt = function(postId) {
        // ê°„ì´ íŒŒì¼ ì—…ë¡œë“œ (Prompt ëŒ€ì‹  hidden inputì„ ì“°ë©´ ì¢‹ì§€ë§Œ, ê°„ë‹¨í•˜ê²Œ êµ¬í˜„)
        // ì‹¤ì œë¡œëŠ” ë³„ë„ ëª¨ë‹¬ì°½ì´ í•„ìš”í•˜ì§€ë§Œ, ì—¬ê¸°ì„  "íŒŒì¼ ì„ íƒì°½"ì„ ë™ì ìœ¼ë¡œ ë„ì›ë‹ˆë‹¤.
        let input = document.createElement('input');
        input.type = 'file';
        input.onchange = e => {
            let file = e.target.files[0];
            let formData = new FormData();
            formData.append("file", file);

            fetch(`/api/posts/${postId}/receipt`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('accessToken') },
                body: formData // Content-Type ìë™ ì„¤ì •ë¨
            }).then(res => {
                if(res.ok) { alert("ì˜ìˆ˜ì¦ ì—…ë¡œë“œ ì™„ë£Œ!"); location.reload(); }
                else alert("ì—…ë¡œë“œ ì‹¤íŒ¨");
            });
        }
        input.click(); // íŒŒì¼ ì„ íƒì°½ ê°•ì œ ì˜¤í”ˆ
    };

    window.completeTransaction = function(postId) {
        if(!confirm("ê±°ë˜ë¥¼ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        fetch(`/api/posts/${postId}/complete`, {
            method: 'PUT',
            headers: { 'Authorization': 'Bearer ' + localStorage.getItem('accessToken') }
        }).then(res => {
            if(res.ok) { alert("ê±°ë˜ ì¢…ë£Œ!"); location.reload(); }
            else alert("ì‹¤íŒ¨");
        });
    };

    window.writeReview = function(postId) {
        let rating = prompt("ë³„ì ì„ ì…ë ¥í•˜ì„¸ìš” (1~5):", "5");
        if(!rating) return;

        fetch(`/api/posts/${postId}/reviews`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
            },
            body: JSON.stringify({ revieweeId: 0, rating: parseInt(rating), comment: "ì¢‹ì•„ìš”" })
            // ì£¼ì˜: revieweeIdëŠ” ì›ë˜ ë°©ì¥ IDë¥¼ ë„£ì–´ì•¼ í•¨.
            // ì§€ê¸ˆì€ ê°„ì†Œí™”ë¥¼ ìœ„í•´ 0ìœ¼ë¡œ ë³´ë‚´ê³  ë°±ì—”ë“œ(ReviewService)ì—ì„œ post.hostUserë¡œ ìë™ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •í•˜ê±°ë‚˜
            // PostResponseDtoì— hostUserIdê°€ ìˆìœ¼ë‹ˆ ê·¸ê±¸ ë„˜ê²¨ì¤˜ì•¼ í•¨.
        }).then(res => {
            // (ReviewServiceë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šì•˜ë‹¤ë©´ 400ì´ ëœ° ìˆ˜ ìˆìŒ.
            //  Dtoì— hostUserIdê°€ ìˆìœ¼ë‹ˆ ê·¸ê±¸ ì¸ìë¡œ ë„˜ê¸°ëŠ”ê²Œ ì •ì„)
            if(res.ok) { alert("í›„ê¸° ì „ì†¡ ì™„ë£Œ!"); location.reload(); }
            else alert("ì´ë¯¸ ì‘ì„±í–ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤.");
        });
    };

    window.toggleDesc = function(postId) {
        const shortDiv = document.getElementById(`desc-short-${postId}`);
        const fullDiv = document.getElementById(`desc-full-${postId}`);

        if (shortDiv.style.display === 'none') {
            // ì ‘ê¸° -> ë”ë³´ê¸° ìƒíƒœë¡œ
            shortDiv.style.display = 'block';
            fullDiv.style.display = 'none';
        } else {
            // ë”ë³´ê¸° -> í¼ì¹¨ ìƒíƒœë¡œ
            shortDiv.style.display = 'none';
            fullDiv.style.display = 'block';
        }
    };


</script>
</body>
</html>