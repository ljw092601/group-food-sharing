<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; width: 100%; max-width: 500px; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        h2 { text-align: center; color: #333; margin-bottom: 30px; }

        /* í”„ë¡œí•„ ì„¹ì…˜ */
        .profile-card { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .nickname { font-size: 24px; font-weight: bold; margin-bottom: 10px; }

        /* ì‹ ë¢°ë„ ì ìˆ˜ ê°•ì¡° */
        .trust-score-box {
            background: #e8f5e9; color: #2e7d32; padding: 15px;
            border-radius: 10px; display: inline-block; margin-top: 10px;
        }
        .trust-score-val { font-size: 32px; font-weight: bold; }
        .trust-label { font-size: 14px; }

        /* ìœ„ì¹˜ ìˆ˜ì • ì„¹ì…˜ */
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #555; }
        #map { width: 100%; height: 250px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 10px; }

        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-save { background: #2196F3; color: white; }
        .btn-save:hover { background: #1976D2; }
        .btn-back { background: #eee; color: #333; margin-top: 10px; }
        .btn-back:hover { background: #ddd; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ‘¤ ë§ˆì´í˜ì´ì§€</h2>

    <div class="profile-card">
        <div class="nickname" id="nickname">ë¡œë”©ì¤‘...</div>
        <div class="trust-score-box">
            <div class="trust-label">ë‚˜ì˜ ì‹ ë¢°ë„</div>
            <div class="trust-score-val" id="trustScore">--</div>
            <div style="font-size:12px; margin-top:5px;">(100ì  ë§Œì )</div>
        </div>
    </div>

    <div style="margin-bottom: 20px;">
        <div class="section-title">ğŸ“ ë‚´ ë™ë„¤ ì„¤ì • ë³€ê²½</div>
        <div style="font-size:12px; color:gray; margin-bottom:5px;">ì´ì‚¬ë¥¼ ê°€ì…¨ë‚˜ìš”? ì§€ë„ë¥¼ í´ë¦­í•´ ìƒˆ ìœ„ì¹˜ë¥¼ ì €ì¥í•˜ì„¸ìš”.</div>
        <div id="map"></div>
        <button class="btn-save" onclick="updateLocation()">ìœ„ì¹˜ ë³€ê²½ ì €ì¥</button>
    </div>

    <hr style="margin: 30px 0; border: 0; border-top: 1px solid #eee;">

    <h3 style="color:#555;">ğŸ“œ ê±°ë˜ ë‚´ì—­</h3>

    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button onclick="loadList('hosted')" id="btn-hosted" style="flex:1; background:#4CAF50; color:white;">ë‚´ê°€ ë§Œë“  ëª¨ì„</button>

        <button onclick="loadList('participated')" id="btn-participated" style="flex:1; background:#ddd; color:black;">ë‚´ê°€ ì°¸ì—¬í•œ ëª¨ì„</button>
    </div>

    <div id="list-container" style="max-height: 300px; overflow-y: auto;">
        <div style="text-align:center; color:gray; padding:20px;">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
    </div>

    <button class="btn-back" onclick="location.href='/'">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_JS_KEY&autoload=false"></script>

<script>
    let map, marker;
    let selectedLat, selectedLng;
    const token = localStorage.getItem('accessToken');

    if (!token) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/login";
    }

    // 1. ì´ˆê¸° ë¡œë”©: ë‚´ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    fetch('/api/users/me', {
        headers: { 'Authorization': 'Bearer ' + token }
    })
        .then(res => res.json())
        .then(user => {
            // ì •ë³´ í‘œì‹œ
            document.getElementById('nickname').innerText = user.nickname;
            document.getElementById('trustScore').innerText = user.trustScore.toFixed(1); // ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€

            // ì§€ë„ ì´ˆê¸°í™” (ê¸°ì¡´ ì„¤ì •ëœ ìœ„ì¹˜ê°€ ìˆë‹¤ë©´ ì¢‹ì§€ë§Œ, ë³´ì•ˆìƒ APIê°€ ì¢Œí‘œë¥¼ ì¤˜ì„œ ê± ê¸°ë³¸ê°’(ë¶€ì‚°ëŒ€ ê·¼ì²˜) ì‚¬ìš©)
            initMap(35.232, 129.082);
        });

    // 2. ì§€ë„ ì´ˆê¸°í™” í•¨ìˆ˜
    function initMap(lat, lng) {
        kakao.maps.load(function() {
            var container = document.getElementById('map');
            var options = { center: new kakao.maps.LatLng(lat, lng), level: 4 };
            map = new kakao.maps.Map(container, options);

            // ë§ˆì»¤ ìƒì„±
            marker = new kakao.maps.Marker({ position: map.getCenter() });
            marker.setMap(map);

            // í´ë¦­ ì´ë²¤íŠ¸: ë§ˆì»¤ ì´ë™ ë° ì¢Œí‘œ ì €ì¥
            kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
                var latlng = mouseEvent.latLng;
                marker.setPosition(latlng);

                selectedLat = latlng.getLat();
                selectedLng = latlng.getLng();
            });
        });
    }

    // 3. ìœ„ì¹˜ ë³€ê²½ ìš”ì²­
    function updateLocation() {
        if (!selectedLat || !selectedLng) {
            alert("ì§€ë„ì—ì„œ ë³€ê²½í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•´ì£¼ì„¸ìš”.");
            return;
        }

        if (!confirm("ì •ë§ ì´ ìœ„ì¹˜ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch('/api/users/me/location', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify({latitude: selectedLat, longitude: selectedLng})
        })
            .then(res => {
                if (res.ok) {
                    alert("ìœ„ì¹˜ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤! ë©”ì¸ í™”ë©´ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”.");
                    window.location.href = "/";
                } else {
                    alert("ë³€ê²½ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            });
        loadList('hosted');
    }

    function loadList(type) {
        const container = document.getElementById('list-container');
        const btnHosted = document.getElementById('btn-hosted');
        const btnParti = document.getElementById('btn-participated');

        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ í† ê¸€
        if (type === 'hosted') {
            btnHosted.style.background = '#4CAF50'; btnHosted.style.color = 'white';
            btnParti.style.background = '#ddd'; btnParti.style.color = 'black';
        } else {
            btnHosted.style.background = '#ddd'; btnHosted.style.color = 'black';
            btnParti.style.background = '#4CAF50'; btnParti.style.color = 'white';
        }

        container.innerHTML = '<div style="text-align:center; padding:20px;">ë¡œë”© ì¤‘...</div>';

        fetch(`/api/users/me/${type}`, {
            headers: { 'Authorization': 'Bearer ' + token }
        })
            .then(res => res.json())
            .then(posts => {
                if (posts.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:gray; padding:20px;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                let html = '';
                posts.forEach(post => {
                    // ìƒíƒœë³„ ìƒ‰ìƒ (ì§€ë„ë‘ ê¹”ë§ì¶¤)
                    let statusColor = '#999';
                    let statusText = post.status;
                    if(post.status === 'RECRUITING') { statusColor = 'blue'; statusText = 'ëª¨ì§‘ì¤‘'; }
                    else if(post.status === 'FULL') { statusColor = '#fbc02d'; statusText = 'ì¸ì›ë§ˆê°'; }
                    else if(post.status === 'PURCHASED') { statusColor = 'red'; statusText = 'êµ¬ë§¤ì™„ë£Œ'; }
                    else if(post.status === 'COMPLETED') { statusColor = 'green'; statusText = 'ê±°ë˜ì™„ë£Œ'; }

                    html += `
                <div style="border:1px solid #eee; padding:15px; margin-bottom:10px; border-radius:8px; background:#f9f9f9;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <strong style="font-size:16px;">${post.itemName}</strong>
                        <span style="font-size:12px; font-weight:bold; color:${statusColor};">${statusText}</span>
                    </div>
                    <div style="font-size:13px; color:#555;">
                        ê°€ê²©: ${post.pricePerUnit.toLocaleString()}ì› | ì¸ì›: ${post.currentUnits}/${post.totalUnits}ëª…
                    </div>
                    <div style="font-size:12px; color:#999; margin-top:5px;">
                        ${post.createdAt}
                        ${type === 'participated' && post.reviewed ? '<span style="color:green; margin-left:5px;">(í›„ê¸°ì‘ì„±ì™„ë£Œ)</span>' : ''}
                    </div>
                </div>
            `;
                });
                container.innerHTML = html;
            });
    }
    loadList('hosted');
</script>

</body>
</html>