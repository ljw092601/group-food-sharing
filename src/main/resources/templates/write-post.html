<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>새 공동구매 모집</title>
    <style>
        body { padding: 20px; font-family: sans-serif; max-width: 600px; margin: auto; background-color: #f9f9f9; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; margin-bottom: 20px; }

        label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .calc-result { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: center; font-weight: bold; }

        #map { width: 100%; height: 300px; border-radius: 5px; margin-top: 5px; border: 1px solid #ccc; }
        .map-hint { font-size: 12px; color: #666; text-align: center; margin-bottom: 10px; }

        button { width: 100%; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
        button:hover { background: #45a049; }
    </style>
</head>
<body>

<div class="container">
    <h2>새 공동구매 모집</h2>
    <form id="postForm">

        <label>물품명</label>
        <input type="text" id="itemName" placeholder="예: 코스트코 베이글 1+1" required>

        <label>상세 설명</label>
        <textarea id="description" rows="3" placeholder="내용을 입력하세요 (예: 6시까지 모여요!)" required></textarea>

        <label>구매처 (URL) <span style="font-weight:normal; color:gray;">(선택)</span></label>
        <input type="url" id="purchaseUrl" placeholder="http://...">

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>총 모집 인원 (본인 포함)</label>
                <input type="number" id="totalUnits" value="2" min="2" oninput="calculatePrice()" required>
            </div>
            <div style="flex: 1;">
                <label>물건 총 가격</label>
                <input type="number" id="totalPrice" placeholder="전체 금액 입력" oninput="calculatePrice()" required>
            </div>
        </div>

        <div class="calc-result" id="calcResult">
            총 가격을 입력하면 1인당 금액이 계산됩니다.
        </div>

        <label>거래 희망 장소 (지도 클릭)</label>
        <div id="map"></div>
        <div class="map-hint">지도를 클릭하거나 드래그해서 마커 위치를 정해주세요.</div>

        <input type="hidden" id="pricePerUnit"> <input type="hidden" id="lat">
        <input type="hidden" id="lng">

        <button type="button" onclick="submitPost()">등록하기</button>
    </form>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_JS_KEY&autoload=false"></script>

<script>
    // 1. 지도 로드
    kakao.maps.load(function() {
        // 초기 위치: 사용자 정보가 있으면 좋겠지만, 없으면 부산대 기본값
        var defaultLat = 35.232;
        var defaultLng = 129.082;

        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(defaultLat, defaultLng),
            level: 3
        };
        var map = new kakao.maps.Map(container, options);

        // 마커 생성
        var marker = new kakao.maps.Marker({
            position: map.getCenter()
        });
        marker.setMap(map);

        // 초기 좌표 저장
        setLatLng(defaultLat, defaultLng);

        // 지도 클릭 이벤트
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            var latlng = mouseEvent.latLng;
            marker.setPosition(latlng);
            setLatLng(latlng.getLat(), latlng.getLng());
        });

        function setLatLng(lat, lng) {
            document.getElementById('lat').value = lat;
            document.getElementById('lng').value = lng;
        }
    });

    // 2. 가격 자동 계산 함수
    function calculatePrice() {
        const totalUnits = parseInt(document.getElementById('totalUnits').value) || 0;
        const totalPrice = parseInt(document.getElementById('totalPrice').value) || 0;
        const resultBox = document.getElementById('calcResult');
        const hiddenInput = document.getElementById('pricePerUnit');

        if (totalUnits > 0 && totalPrice > 0) {
            // 1인당 가격 계산 (소수점 버림)
            const perPerson = Math.floor(totalPrice / totalUnits);

            resultBox.innerHTML = `1인당 부담금: <strong>${perPerson.toLocaleString()}원</strong>`;
            hiddenInput.value = perPerson; // 서버로 보낼 값 저장
        } else {
            resultBox.innerText = "총 가격과 인원을 입력해주세요.";
            hiddenInput.value = "";
        }
    }

    // 3. 글 등록 함수
    function submitPost() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert("로그인이 필요합니다.");
            window.location.href = "/login";
            return;
        }

        const pricePerUnit = document.getElementById('pricePerUnit').value;
        if (!pricePerUnit) {
            alert("가격을 올바르게 입력해주세요.");
            return;
        }

        const data = {
            itemName: document.getElementById('itemName').value,
            description: document.getElementById('description').value,
            purchaseUrl: document.getElementById('purchaseUrl').value, // [추가]
            totalUnits: parseInt(document.getElementById('totalUnits').value),
            pricePerUnit: parseFloat(pricePerUnit), // 계산된 값 전송
            longitude: parseFloat(document.getElementById('lng').value),
            latitude: parseFloat(document.getElementById('lat').value)
        };

        fetch('/api/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(data)
        })
            .then(async response => {
                if (response.ok) {
                    alert("등록되었습니다!");
                    window.location.href = "/";
                } else {
                    let msg = await response.text();
                    alert("등록 실패: " + msg);
                }
            })
            .catch(err => {
                console.error(err);
                alert("오류가 발생했습니다.");
            });
    }
</script>

</body>
</html>