<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìƒˆ ê³µë™êµ¬ë§¤ ëª¨ì§‘</title>
    <style>
        body { padding: 20px; font-family: sans-serif; max-width: 600px; margin: auto; background-color: #f9f9f9; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; margin-bottom: 20px; }

        label { display: block; margin-top: 15px; font-weight: bold; font-size: 14px; }
        input, textarea { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .calc-result { background: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 5px; margin-top: 10px; text-align: center; font-weight: bold; }

        #map { width: 100%; height: 300px; border-radius: 5px; margin-top: 5px; border: 1px solid #ccc; }
        .map-hint { font-size: 12px; color: #666; text-align: center; margin-bottom: 10px; }

        button { width: 100%; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 20px; }
        button:hover { background: #45a049; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“¦ ìƒˆ ê³µë™êµ¬ë§¤ ëª¨ì§‘</h2>
    <form id="postForm">

        <label>ë¬¼í’ˆëª…</label>
        <input type="text" id="itemName" placeholder="ì˜ˆ: ì½”ìŠ¤íŠ¸ì½” ë² ì´ê¸€ 1+1" required>

        <label>ìƒì„¸ ì„¤ëª…</label>
        <textarea id="description" rows="3" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 6ì‹œê¹Œì§€ ëª¨ì—¬ìš”!)" required></textarea>

        <label>êµ¬ë§¤ì²˜ (URL) <span style="font-weight:normal; color:gray;">(ì„ íƒ)</span></label>
        <input type="url" id="purchaseUrl" placeholder="http://...">

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label>ì´ ëª¨ì§‘ ì¸ì› (ë³¸ì¸ í¬í•¨)</label>
                <input type="number" id="totalUnits" value="2" min="2" oninput="calculatePrice()" required>
            </div>
            <div style="flex: 1;">
                <label>ë¬¼ê±´ ì´ ê°€ê²©</label>
                <input type="number" id="totalPrice" placeholder="ì „ì²´ ê¸ˆì•¡ ì…ë ¥" oninput="calculatePrice()" required>
            </div>
        </div>

        <div class="calc-result" id="calcResult">
            ì´ ê°€ê²©ì„ ì…ë ¥í•˜ë©´ 1ì¸ë‹¹ ê¸ˆì•¡ì´ ê³„ì‚°ë©ë‹ˆë‹¤.
        </div>

        <label>ê±°ë˜ í¬ë§ ì¥ì†Œ (ì§€ë„ í´ë¦­)</label>
        <div id="map"></div>
        <div class="map-hint">ğŸ“ ì§€ë„ë¥¼ í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ ë§ˆì»¤ ìœ„ì¹˜ë¥¼ ì •í•´ì£¼ì„¸ìš”.</div>

        <input type="hidden" id="pricePerUnit"> <input type="hidden" id="lat">
        <input type="hidden" id="lng">

        <button type="button" onclick="submitPost()">ë“±ë¡í•˜ê¸°</button>
    </form>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_JS_KEY&autoload=false"></script>

<script>
    // 1. ì§€ë„ ë¡œë“œ
    kakao.maps.load(function() {
        // ì´ˆê¸° ìœ„ì¹˜: ì‚¬ìš©ì ì •ë³´ê°€ ìˆìœ¼ë©´ ì¢‹ê² ì§€ë§Œ, ì—†ìœ¼ë©´ ë¶€ì‚°ëŒ€ ê¸°ë³¸ê°’
        var defaultLat = 35.232;
        var defaultLng = 129.082;

        var container = document.getElementById('map');
        var options = {
            center: new kakao.maps.LatLng(defaultLat, defaultLng),
            level: 3
        };
        var map = new kakao.maps.Map(container, options);

        // ë§ˆì»¤ ìƒì„±
        var marker = new kakao.maps.Marker({
            position: map.getCenter()
        });
        marker.setMap(map);

        // ì´ˆê¸° ì¢Œí‘œ ì €ì¥
        setLatLng(defaultLat, defaultLng);

        // ì§€ë„ í´ë¦­ ì´ë²¤íŠ¸
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
            var latlng = mouseEvent.latLng;
            marker.setPosition(latlng);
            setLatLng(latlng.getLat(), latlng.getLng());
        });

        function setLatLng(lat, lng) {
            document.getElementById('lat').value = lat;
            document.getElementById('lng').value = lng;
        }
    });

    // 2. ê°€ê²© ìë™ ê³„ì‚° í•¨ìˆ˜
    function calculatePrice() {
        const totalUnits = parseInt(document.getElementById('totalUnits').value) || 0;
        const totalPrice = parseInt(document.getElementById('totalPrice').value) || 0;
        const resultBox = document.getElementById('calcResult');
        const hiddenInput = document.getElementById('pricePerUnit');

        if (totalUnits > 0 && totalPrice > 0) {
            // 1ì¸ë‹¹ ê°€ê²© ê³„ì‚° (ì†Œìˆ˜ì  ë²„ë¦¼)
            const perPerson = Math.floor(totalPrice / totalUnits);

            resultBox.innerHTML = `ğŸ’¡ 1ì¸ë‹¹ ë¶€ë‹´ê¸ˆ: <strong>${perPerson.toLocaleString()}ì›</strong>`;
            hiddenInput.value = perPerson; // ì„œë²„ë¡œ ë³´ë‚¼ ê°’ ì €ì¥
        } else {
            resultBox.innerText = "ì´ ê°€ê²©ê³¼ ì¸ì›ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
            hiddenInput.value = "";
        }
    }

    // 3. ê¸€ ë“±ë¡ í•¨ìˆ˜
    function submitPost() {
        const token = localStorage.getItem('accessToken');
        if (!token) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = "/login";
            return;
        }

        const pricePerUnit = document.getElementById('pricePerUnit').value;
        if (!pricePerUnit) {
            alert("ê°€ê²©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return;
        }

        const data = {
            itemName: document.getElementById('itemName').value,
            description: document.getElementById('description').value,
            purchaseUrl: document.getElementById('purchaseUrl').value, // [ì¶”ê°€]
            totalUnits: parseInt(document.getElementById('totalUnits').value),
            pricePerUnit: parseFloat(pricePerUnit), // ê³„ì‚°ëœ ê°’ ì „ì†¡
            longitude: parseFloat(document.getElementById('lng').value),
            latitude: parseFloat(document.getElementById('lat').value)
        };

        fetch('/api/posts', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(data)
        })
            .then(async response => {
                if (response.ok) {
                    alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    window.location.href = "/";
                } else {
                    let msg = await response.text();
                    alert("ë“±ë¡ ì‹¤íŒ¨: " + msg);
                }
            })
            .catch(err => {
                console.error(err);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            });
    }
</script>

</body>
</html>